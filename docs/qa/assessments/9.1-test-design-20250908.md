# Test Design: Story 9.1 - Core Document Analysis Pipeline

Date: 2025-09-08
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 28
- Unit tests: 12 (43%)
- Integration tests: 10 (36%)
- E2E tests: 6 (21%)
- Priority distribution: P0: 10, P1: 12, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Document upload supports multiple formats (PDF, DOCX, MD, TXT) with drag-and-drop

#### Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 9.1-UNIT-001 | Unit | P0 | Validate file type checking logic | Pure validation logic for security |
| 9.1-UNIT-002 | Unit | P1 | Test file size validation | Business rule validation |
| 9.1-INT-001 | Integration | P0 | Upload API accepts valid formats | Critical path component interaction |
| 9.1-INT-002 | Integration | P1 | Drag-drop zone processes files | UI component integration |
| 9.1-E2E-001 | E2E | P0 | User successfully uploads document | Critical user journey |

### AC2: Real-time analysis progress shown during document processing

#### Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 9.1-UNIT-003 | Unit | P1 | Progress calculation logic | Pure calculation function |
| 9.1-INT-003 | Integration | P0 | WebSocket connection establishment | Multi-component communication |
| 9.1-INT-004 | Integration | P1 | Progress events transmission | Real-time data flow |
| 9.1-E2E-002 | E2E | P1 | User sees live progress updates | User experience validation |

### AC3: AI generates custom entity and edge type suggestions based on document content

#### Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 9.1-UNIT-004 | Unit | P0 | Type extraction from content | Core algorithm logic |
| 9.1-UNIT-005 | Unit | P0 | Format suggestions to Zep v3 spec | Data transformation logic |
| 9.1-INT-005 | Integration | P0 | OpenAI API integration | External service integration |
| 9.1-INT-006 | Integration | P0 | TypeSuggestionEngine pipeline | Multi-service orchestration |

### AC4: Classification rate prediction displayed before user commits to types

#### Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 9.1-UNIT-006 | Unit | P0 | Classification rate calculation | Pure calculation algorithm |
| 9.1-UNIT-007 | Unit | P1 | Confidence score generation | Statistical computation |
| 9.1-INT-007 | Integration | P1 | Preview endpoint returns metrics | API response formatting |

### AC5: Analysis completes within 30 seconds for typical documents

#### Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 9.1-UNIT-008 | Unit | P0 | Timeout handler logic | Critical error handling |
| 9.1-INT-008 | Integration | P0 | End-to-end processing time | Performance requirement |
| 9.1-E2E-003 | E2E | P1 | User workflow within time limit | User experience requirement |

### AC6: Results cached for repeated analysis of same document

#### Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 9.1-UNIT-009 | Unit | P1 | Cache key generation (document hash) | Pure hashing function |
| 9.1-UNIT-010 | Unit | P2 | TTL expiration logic | Cache management logic |
| 9.1-INT-009 | Integration | P1 | Cache hit/miss behavior | Storage integration |
| 9.1-E2E-004 | E2E | P2 | Faster second analysis | Performance optimization |

### AC7: Error handling for unsupported formats or processing failures

#### Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 9.1-UNIT-011 | Unit | P0 | Error message formatting | User communication |
| 9.1-UNIT-012 | Unit | P1 | Retry queue logic | Recovery mechanism |
| 9.1-INT-010 | Integration | P0 | API error responses | Error propagation |
| 9.1-E2E-005 | E2E | P1 | User sees helpful error messages | User experience |
| 9.1-E2E-006 | E2E | P2 | Recovery from failures | System resilience |

## Risk Coverage

### Identified Risks
- RISK-001: File upload security vulnerabilities (mitigated by 9.1-UNIT-001)
- RISK-002: OpenAI API failures (mitigated by 9.1-INT-005, 9.1-UNIT-012)
- RISK-003: Performance degradation (mitigated by 9.1-INT-008, 9.1-E2E-003)
- RISK-004: Data loss on failures (mitigated by 9.1-INT-009, 9.1-UNIT-012)

## Recommended Execution Order

1. P0 Unit tests (fail fast): 9.1-UNIT-001, 004, 005, 006, 008, 011
2. P0 Integration tests: 9.1-INT-001, 003, 005, 006, 008, 010
3. P0 E2E tests: 9.1-E2E-001
4. P1 tests in order: Unit → Integration → E2E
5. P2 tests as time permits

## Testing Tools & Approaches

### Unit Tests
- Framework: Jest with TypeScript
- Location: Adjacent to source files (*.test.ts)
- Mocking: Jest mocks for external dependencies
- Coverage target: 80%

### Integration Tests
- Framework: Jest with Supertest for API testing
- Location: src/app/api/**/__tests__/
- Mocking: MSW for external services (OpenAI, Airtable)
- Focus: Component boundaries and data flow

### E2E Tests
- Framework: Playwright
- Location: tests/e2e/
- Environment: Staging with test data
- Focus: Critical user journeys

## Quality Checklist

- [x] Every AC has test coverage
- [x] No duplicate coverage across levels
- [x] Critical paths have multiple levels
- [x] Risk mitigations are addressed
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent