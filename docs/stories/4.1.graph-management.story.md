# Story 4.1: Knowledge Graph Management Interface

## Status
Ready for Review

```text-block
REVIEW STATUS: APPROVED FOR DEVELOPMENT
Review Date: 2025-01-05
Reviewed By: Bob (Scrum Master)
Review Notes: Story implements graph management for organizing different knowledge domains.
Supports multiple graphs with ontology selection.
Archive functionality preserves data without deletion.
Foundation for all graph operations.
Ready for implementation in Sprint 4.
```

## Story
**As a** user,
**I want** to create and manage multiple knowledge graphs,
**So that** I can organize different domains or projects separately.

## Acceptance Criteria
1. Create new knowledge graph with name, description, and ontology selection
2. List view of all graphs showing entity/edge counts and last modified date
3. Set active graph for document processing operations
4. Archive inactive graphs without deletion
5. Graph metadata editing (name, description, tags)
6. Graph statistics dashboard (total entities, edges, documents processed)
7. Export graph metadata and structure as JSON

## Tasks / Subtasks
- [x] **Task 1: Create Graph Management UI** (AC: 1, 2)
  - [x] Build GraphManagement component
  - [x] Create GraphList with data table
  - [x] Add NewGraphDialog with form
  - [x] Implement ontology selector dropdown
  - [x] Add validation for unique names

- [x] **Task 2: Implement Create Graph** (AC: 1)
  - [x] Create graph record in Airtable
  - [x] Link selected ontology
  - [x] Initialize empty entity/edge collections
  - [x] Set creation metadata
  - [x] Generate unique graph ID

- [x] **Task 3: Build Active Graph Selection** (AC: 3)
  - [x] Create active graph context
  - [x] Add graph selector in header
  - [x] Store active selection in localStorage
  - [x] Update all operations to use active graph
  - [x] Show active indicator in list

- [x] **Task 4: Add Archive Functionality** (AC: 4)
  - [x] Implement soft delete with status
  - [x] Create archive/restore actions
  - [x] Filter archived from main list
  - [x] Add archived graphs view
  - [x] Prevent operations on archived graphs

- [x] **Task 5: Enable Metadata Editing** (AC: 5)
  - [x] Create EditGraphDialog component
  - [x] Support name/description updates
  - [x] Implement tag management
  - [x] Add last modified tracking
  - [x] Validate changes before save

- [x] **Task 6: Build Statistics Dashboard** (AC: 6)
  - [x] Create GraphStatistics component
  - [x] Count entities by type
  - [x] Count edges by type
  - [x] Show processed documents count
  - [x] Display creation/update dates
  - [x] Add growth charts over time

- [x] **Task 7: Export Graph Data** (AC: 7)
  - [x] Create export dialog
  - [x] Generate JSON structure
  - [x] Include metadata and statistics
  - [x] Option to include/exclude data
  - [x] Download as file

## Dev Notes

### Component Structure
```
src/components/graphs/
├── GraphManagement.tsx      # Main management interface
├── GraphList.tsx            # List of all graphs
├── GraphCard.tsx            # Card view option
├── GraphStatistics.tsx      # Statistics dashboard
├── dialogs/
│   ├── NewGraphDialog.tsx
│   ├── EditGraphDialog.tsx
│   └── ExportGraphDialog.tsx
├── selectors/
│   ├── ActiveGraphSelector.tsx
│   └── OntologySelector.tsx
└── context/
    └── ActiveGraphContext.tsx
```

### Graph Data Model
```typescript
interface KnowledgeGraph {
  id: string
  name: string
  description: string
  ontologyId: string
  status: 'active' | 'archived' | 'processing'
  metadata: {
    createdAt: Date
    updatedAt: Date
    createdBy: string
    lastModifiedBy: string
    tags: string[]
  }
  statistics: {
    entityCount: number
    edgeCount: number
    documentCount: number
    lastProcessedAt?: Date
    sizeInBytes: number
  }
  settings: {
    isActive: boolean
    isPublic: boolean
    allowCloning: boolean
    processingEnabled: boolean
  }
}
```

### Airtable Schema
```typescript
// Graphs Table
interface GraphRecord {
  id: string
  name: string
  description: string
  ontologyId: string  // Link to Ontologies table
  status: string
  entities: string[]  // Links to Entities table
  edges: string[]     // Links to Edges table
  documents: string[] // Links to Documents table
  createdAt: Date
  updatedAt: Date
  createdBy: string
  tags: string[]
  isActive: boolean
  isArchived: boolean
}
```

### Active Graph Context
```typescript
interface ActiveGraphContextType {
  activeGraph: KnowledgeGraph | null
  setActiveGraph: (graph: KnowledgeGraph) => void
  clearActiveGraph: () => void
  isLoading: boolean
}

const ActiveGraphContext = createContext<ActiveGraphContextType>()

export function useActiveGraph() {
  const context = useContext(ActiveGraphContext)
  if (!context) {
    throw new Error('useActiveGraph must be used within ActiveGraphProvider')
  }
  return context
}
```

### Statistics Calculation
```typescript
async function calculateGraphStatistics(graphId: string): Promise<GraphStatistics> {
  const [entities, edges, documents] = await Promise.all([
    getEntitiesByGraph(graphId),
    getEdgesByGraph(graphId),
    getDocumentsByGraph(graphId)
  ])
  
  return {
    entityCount: entities.length,
    edgeCount: edges.length,
    documentCount: documents.length,
    entityTypeCounts: groupBy(entities, 'type'),
    edgeTypeCounts: groupBy(edges, 'type'),
    lastProcessedAt: getLatestDate(documents),
    sizeInBytes: calculateSize(entities, edges, documents)
  }
}
```

### Export Format
```json
{
  "version": "1.0",
  "exportDate": "2025-01-05T10:00:00Z",
  "graph": {
    "id": "graph_123",
    "name": "Business Knowledge Graph",
    "description": "Company relationships and entities",
    "ontologyId": "ont_456",
    "metadata": {
      "createdAt": "2025-01-01T00:00:00Z",
      "tags": ["business", "relationships"]
    },
    "statistics": {
      "entityCount": 1500,
      "edgeCount": 3200,
      "documentCount": 45
    },
    "structure": {
      "entityTypes": ["Person", "Company", "Product"],
      "edgeTypes": ["Employment", "Ownership", "Partnership"]
    }
  },
  "includesData": false
}
```

### Archive Implementation
```typescript
async function archiveGraph(graphId: string): Promise<void> {
  // Soft delete - keep data but mark as archived
  await updateGraph(graphId, {
    status: 'archived',
    isArchived: true,
    isActive: false,
    archivedAt: new Date(),
    archivedBy: currentUser.id
  })
  
  // Remove from active graph if selected
  if (activeGraph?.id === graphId) {
    clearActiveGraph()
  }
  
  // Prevent further operations
  disableGraphOperations(graphId)
}

async function restoreGraph(graphId: string): Promise<void> {
  await updateGraph(graphId, {
    status: 'active',
    isArchived: false,
    isActive: true,
    restoredAt: new Date(),
    restoredBy: currentUser.id
  })
  
  enableGraphOperations(graphId)
}
```

### Performance Considerations
```typescript
// Use pagination for large graph lists
const GRAPHS_PER_PAGE = 20

// Cache statistics for performance
const statisticsCache = new Map<string, {
  data: GraphStatistics
  timestamp: Date
}>()

// Lazy load graph data
function useGraphData(graphId: string) {
  return useQuery({
    queryKey: ['graph', graphId],
    queryFn: () => fetchGraphData(graphId),
    staleTime: 5 * 60 * 1000 // 5 minutes
  })
}
```

### shadcn-ui Components to Use
- DataTable (graph list)
- Card (graph cards)
- Dialog (create/edit/export)
- Select (ontology selector)
- Badge (tags, status)
- Tabs (active/archived views)
- Button (actions)
- Chart (statistics)

### Testing Standards
- Test graph CRUD operations
- Verify active graph context
- Test archive/restore flow
- Validate export format
- Test statistics calculation
- Check performance with many graphs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during development*

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Created Graphs table in Airtable (tblKBwwyf3xrCVlH6)
- Implemented GraphService for CRUD operations
- Built GraphManagement UI with data table
- Created ActiveGraphContext with localStorage persistence
- Added graph selector to header
- Implemented archive/restore functionality

### Completion Notes List
- All 7 tasks completed successfully
- Created new Graphs table in Airtable with all required fields
- Implemented complete CRUD operations for graphs
- Added ActiveGraphContext for global state management
- Built comprehensive UI with list, create, edit, export dialogs
- Integrated graph selector into main header
- Archive functionality works with soft delete
- Export generates downloadable JSON files
- Statistics dashboard shows real-time metrics

### File List
**New Files:**
- src/lib/types/graph.ts - Graph type definitions
- src/lib/airtable/services/graph.service.ts - Graph service implementation
- src/components/graphs/GraphManagement.tsx - Main management interface
- src/components/graphs/GraphList.tsx - Data table component
- src/components/graphs/GraphStatistics.tsx - Statistics dashboard
- src/components/graphs/context/ActiveGraphContext.tsx - Context provider
- src/components/graphs/dialogs/NewGraphDialog.tsx - Create dialog
- src/components/graphs/dialogs/EditGraphDialog.tsx - Edit dialog
- src/components/graphs/dialogs/ExportGraphDialog.tsx - Export dialog
- src/components/graphs/selectors/ActiveGraphSelector.tsx - Header selector

**Modified Files:**
- src/lib/types/airtable.ts - Added GraphRecord type
- src/lib/airtable/services/index.ts - Added GraphService export
- src/pages/Graphs.tsx - Updated to use GraphManagement
- src/components/layout/Header.tsx - Added ActiveGraphSelector
- src/main.tsx - Added ActiveGraphProvider at root
- src/router/routes.tsx - Already had /graphs route

## QA Results

### Review Date: 2025-01-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** - Story 4.1 demonstrates comprehensive graph management implementation with all acceptance criteria fully addressed. The implementation shows strong architectural patterns with proper separation of concerns, context management, and performance optimization. All 7 tasks completed with proper Airtable integration and UI components.

### Requirements Traceability

- **AC1 (Create new knowledge graph)**: ✅ Fully implemented with NewGraphDialog, ontology selection, validation
- **AC2 (List view with counts)**: ✅ GraphList with DataTable showing all required metrics
- **AC3 (Set active graph)**: ✅ ActiveGraphContext with localStorage persistence and header selector
- **AC4 (Archive inactive graphs)**: ✅ Soft delete implementation with status management
- **AC5 (Graph metadata editing)**: ✅ EditGraphDialog with full metadata support
- **AC6 (Statistics dashboard)**: ✅ GraphStatistics component with real-time metrics
- **AC7 (Export as JSON)**: ✅ ExportGraphDialog with configurable export options

### Test Coverage Assessment

**Missing Critical Tests:**
- No unit tests for GraphService CRUD operations
- No integration tests for Airtable operations
- No tests for ActiveGraphContext state management
- No E2E tests for complete workflows

### Compliance Check

- Coding Standards: ✅ TypeScript interfaces well-defined, proper component structure
- Project Structure: ✅ Follows documented patterns in src/components/graphs/
- Testing Strategy: ❌ No test files listed in implementation
- All ACs Met: ✅ All 7 acceptance criteria fully implemented

### Security Review

- **Input Validation**: ✅ Unique name validation implemented
- **Access Control**: ⚠️ No user-level permissions mentioned (may be handled at higher level)
- **Data Isolation**: ✅ Proper graph isolation with unique IDs

### Performance Considerations

- **Caching**: ✅ Statistics cache implementation noted
- **Pagination**: ✅ GRAPHS_PER_PAGE = 20 for large lists
- **Lazy Loading**: ✅ useQuery with 5-minute stale time
- **Batch Operations**: ✅ Parallel fetching in calculateGraphStatistics

### Improvements Checklist

- [ ] Add comprehensive test suite for GraphService
- [ ] Implement integration tests for Airtable operations
- [ ] Add unit tests for ActiveGraphContext
- [ ] Create E2E test for graph creation workflow
- [ ] Add error handling for Airtable connection failures
- [ ] Consider implementing optimistic updates for better UX
- [ ] Add audit logging for graph operations

### Risk Assessment

- **Low Risk**: Well-structured implementation with clear patterns
- **Medium Risk**: Lack of test coverage could lead to regression issues
- **Mitigation**: Prioritize test implementation before production deployment

### Gate Status

Gate: CONCERNS → docs/qa/gates/4.1-graph-management.yml

### Recommended Status

[✗ Changes Required - Add test coverage before marking as Done]

---
**Story Points**: 5 (2-3 days)
**Sprint**: Sprint 4
**Priority**: P0 - Must Have
**Dependencies**: Epics 1, 2, and 3 should be completed first