# Story 3.2: Entity Type Definition Editor

## Status
Ready for Review

```text-block
REVIEW STATUS: APPROVED FOR DEVELOPMENT
Review Date: 2025-01-05
Reviewed By: Bob (Scrum Master)
Review Notes: Entity type editor story approved for development.
Visual Pydantic model builder with comprehensive field type support.
All common Python types supported (int, str, float, datetime, bool, list).
Field constraints and validators fully specified.
Live code preview with syntax highlighting included.
Protected attribute validation prevents conflicts.
Depends on Story 3.1 for ontology context.
```

## Story
**As a** user,
**I want** to create and edit Pydantic-based entity type definitions,
**So that** I can define custom attributes for extracted entities.

## Acceptance Criteria
1. Form-based interface for creating entity type classes (Person, Company, Product, etc.)
2. Field editor supporting Optional types with descriptions
3. Support for int, str, float, datetime, bool, and list field types
4. Pydantic Field configuration (description, default values, constraints)
5. Code generation preview showing resulting Python Pydantic model
6. Validation of field names against protected attributes (uuid, name, created_at, etc.)
7. Syntax validation and error highlighting for generated models

## Tasks / Subtasks
- [x] **Task 1: Create Entity Type Form** (AC: 1)
  - [x] Build EntityTypeEditor component
  - [x] Add entity name input with validation
  - [x] Create entity description field
  - [x] Implement base class selector
  - [x] Add icon/color customization

- [x] **Task 2: Build Field Editor** (AC: 2, 3)
  - [x] Create FieldEditor component
  - [x] Implement field name input
  - [x] Add type selector dropdown
  - [x] Support Optional wrapper toggle
  - [x] Add field description input
  - [x] Enable field reordering

- [x] **Task 3: Add Field Type Support** (AC: 3)
  - [x] Implement primitive types (str, int, float, bool)
  - [x] Add datetime type with format options
  - [x] Support List[T] for collections
  - [x] Add Dict[K, V] for mappings
  - [x] Implement Union types
  - [x] Add custom type references

- [x] **Task 4: Configure Field Constraints** (AC: 4)
  - [x] Add default value editor
  - [x] Implement min/max for numbers
  - [x] Add regex patterns for strings
  - [x] Create min/max length for strings/lists
  - [x] Add enum value constraints
  - [x] Implement custom validators

- [x] **Task 5: Generate Code Preview** (AC: 5)
  - [x] Create CodePreview component
  - [x] Generate Pydantic model code
  - [x] Add syntax highlighting
  - [x] Include imports and docstrings
  - [x] Show Field configurations
  - [x] Add copy-to-clipboard button

- [x] **Task 6: Validate Field Names** (AC: 6)
  - [x] Check against reserved words
  - [x] Validate Python identifier rules
  - [x] Prevent protected attribute conflicts
  - [x] Check for duplicate field names
  - [x] Validate against Graphiti requirements

- [x] **Task 7: Implement Syntax Validation** (AC: 7)
  - [x] Validate generated Python code
  - [x] Highlight syntax errors
  - [x] Check import requirements
  - [x] Validate type annotations
  - [x] Test model instantiation

## Dev Notes

### Component Structure
```
src/components/ontology/entity/
├── EntityTypeEditor.tsx      # Main editor component
├── EntityTypeForm.tsx        # Form container
├── FieldEditor.tsx          # Individual field editor
├── FieldList.tsx            # List of fields with reorder
├── TypeSelector.tsx         # Field type dropdown
├── ConstraintEditor.tsx     # Field constraints form
├── CodePreview.tsx          # Generated code display
└── ValidationPanel.tsx      # Validation errors/warnings
```

### Entity Type Model
```typescript
interface EntityTypeDefinition {
  id: string
  ontologyId: string
  name: string  // PascalCase class name
  description: string
  baseClass: 'BaseModel' | 'CustomBase'
  fields: EntityField[]
  metadata: {
    icon?: string
    color?: string
    category?: string
  }
  validation: {
    isValid: boolean
    errors: ValidationError[]
    warnings: ValidationWarning[]
  }
}

interface EntityField {
  name: string
  type: FieldType
  isOptional: boolean
  description?: string
  default?: any
  constraints?: FieldConstraints
  metadata?: {
    uiOrder: number
    uiHidden?: boolean
  }
}

type FieldType = 
  | 'str' | 'int' | 'float' | 'bool' | 'datetime'
  | { list: FieldType }
  | { dict: { key: FieldType, value: FieldType } }
  | { union: FieldType[] }
  | { custom: string }

interface FieldConstraints {
  // String constraints
  minLength?: number
  maxLength?: number
  pattern?: string
  
  // Numeric constraints
  gt?: number
  ge?: number
  lt?: number
  le?: number
  
  // General constraints
  enum?: any[]
  const?: any
  
  // Custom validators
  validators?: string[]
}
```

### Code Generation Template
```python
# Generated Pydantic Model
from pydantic import BaseModel, Field, validator
from typing import Optional, List, Dict, Union
from datetime import datetime

class {EntityName}(BaseModel):
    """{EntityDescription}"""
    
    # Fields
    {field_name}: {field_type} = Field(
        {default_value},
        description="{field_description}",
        {constraints}
    )
    
    # Validators
    @validator('{field_name}')
    def validate_{field_name}(cls, v):
        {validation_logic}
        return v
    
    class Config:
        use_enum_values = True
        validate_assignment = True
```

### Protected Attributes
```typescript
const PROTECTED_ATTRIBUTES = [
  'uuid', 'id', 'name', 'created_at', 'updated_at',
  'entity_type', 'entity_definition_id', 'document_id'
]

const PYTHON_RESERVED = [
  'class', 'def', 'return', 'if', 'else', 'elif',
  'for', 'while', 'import', 'from', 'as', 'with',
  'try', 'except', 'finally', 'raise', 'assert'
]
```

### Field Type Mapping
```typescript
const TYPE_MAPPINGS = {
  'str': 'str',
  'int': 'int',
  'float': 'float',
  'bool': 'bool',
  'datetime': 'datetime',
  'list_str': 'List[str]',
  'list_int': 'List[int]',
  'dict_str_str': 'Dict[str, str]',
  'optional_str': 'Optional[str]',
  'union_str_int': 'Union[str, int]'
}
```

### Validation Rules
```typescript
function validateEntityType(entity: EntityTypeDefinition): ValidationResult {
  const errors: ValidationError[] = []
  const warnings: ValidationWarning[] = []
  
  // Check entity name
  if (!entity.name.match(/^[A-Z][a-zA-Z0-9]*$/)) {
    errors.push({
      field: 'name',
      message: 'Entity name must be PascalCase'
    })
  }
  
  // Check for duplicate fields
  const fieldNames = entity.fields.map(f => f.name)
  const duplicates = fieldNames.filter((name, index) => 
    fieldNames.indexOf(name) !== index
  )
  
  // Check field names
  entity.fields.forEach(field => {
    if (PROTECTED_ATTRIBUTES.includes(field.name)) {
      errors.push({
        field: field.name,
        message: `Field name '${field.name}' is protected`
      })
    }
    
    if (PYTHON_RESERVED.includes(field.name)) {
      errors.push({
        field: field.name,
        message: `Field name '${field.name}' is a Python reserved word`
      })
    }
  })
  
  return { isValid: errors.length === 0, errors, warnings }
}
```

### Live Code Preview
```typescript
function generatePydanticCode(entity: EntityTypeDefinition): string {
  const imports = generateImports(entity)
  const classDefinition = generateClass(entity)
  const fields = entity.fields.map(generateField).join('\n    ')
  const validators = generateValidators(entity)
  
  return `${imports}

${classDefinition}
    ${fields}
    
    ${validators}
    
    class Config:
        use_enum_values = True
        validate_assignment = True
`
}
```

### shadcn-ui Components to Use
- Form (React Hook Form integration)
- Input (field names, descriptions)
- Select (type selection)
- Switch (Optional toggle)
- Button (add/remove fields)
- Card (field containers)
- Tabs (form/preview)
- Alert (validation errors)
- Code block (preview)

### Testing Standards
- Test field type generation
- Validate constraint application
- Test code generation accuracy
- Verify Python syntax validity
- Test protected attribute validation
- Check field name validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-05 | 1.1 | Reviewed and approved for development | Bob (Scrum Master) |
| 2025-01-06 | 1.2 | Applied QA fixes for TEST-001 and MNT-001 | James (Dev) |
| 2025-01-08 | 1.3 | Applied additional QA fixes per gate review | James (Dev) |

## Dev Agent Record
*Completed on 2025-01-06*

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Component architecture validated
- Field type system implemented
- Code generation tested
- Validation rules enforced
- Added edge case tests for regex patterns and enum constraints (TEST-001)
- Refactored code generation into modular architecture (MNT-001)
- All tests passing: validation.test.ts (20 tests), codeGenerator.test.ts (9 tests)
- Added comprehensive edge case tests for constraint validation (2025-01-08)
- Created modular field-type-mappers.ts for better maintainability (2025-01-08)
- Added 6 new constraint validation test scenarios (2025-01-08)

### Completion Notes List
- All tasks completed successfully
- Full Pydantic model generation working
- Field validation includes protected attributes and Python reserved words
- Drag-and-drop field reordering implemented
- Syntax highlighting with Prism.js
- Comprehensive test coverage added
- QA Issues Resolved (2025-01-08):
  - TEST-001: Added 14 new edge case tests for complex constraint validation
  - MNT-001: Refactored code generation into modular architecture with field-type-mappers.ts

### File List
Created:
- src/types/ontology.ts
- src/lib/ontology/validation.ts
- src/lib/ontology/codeGenerator.ts (refactored to re-export from modular files)
- src/lib/ontology/codeGenerator/index.ts
- src/lib/ontology/codeGenerator/typeMappers.ts
- src/lib/ontology/codeGenerator/constraintGenerators.ts
- src/lib/ontology/codeGenerator/fieldGenerators.ts
- src/lib/ontology/codeGenerator/importGenerators.ts
- src/lib/ontology/codeGenerator/validatorGenerators.ts
- src/lib/ontology/field-type-mappers.ts (2025-01-08)
- src/lib/ontology/__tests__/field-type-mappers.test.ts (2025-01-08)
- src/components/ontology/entity/EntityTypeEditor.tsx
- src/components/ontology/entity/EntityTypeForm.tsx
- src/components/ontology/entity/FieldEditor.tsx
- src/components/ontology/entity/FieldList.tsx
- src/components/ontology/entity/SortableFieldEditor.tsx
- src/components/ontology/entity/TypeSelector.tsx
- src/components/ontology/entity/ConstraintEditor.tsx
- src/components/ontology/entity/CodePreview.tsx
- src/components/ontology/entity/ValidationPanel.tsx
- src/components/ontology/entity/__tests__/EntityTypeEditor.test.tsx
- src/lib/ontology/__tests__/validation.test.ts
- src/lib/ontology/__tests__/codeGenerator.test.ts

Modified:
- package.json (added dependencies: prismjs, @types/prismjs, @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities)
- src/lib/ontology/validation.ts (enhanced with constraint validation logic)
- src/lib/ontology/__tests__/validation.test.ts (added 8 edge case tests)
- src/components/ontology/entity/__tests__/EntityTypeEditor.test.tsx (added 6 constraint validation edge case tests, 2025-01-08)

## QA Results

### Review Date: 2025-01-05

### Reviewed By: Quinn (Test Architect)

**Test Design**: Strong test coverage with 29 test scenarios across all acceptance criteria. Excellent validation logic testing for protected attributes and Python compliance. Code generation thoroughly tested.

**Risk Assessment**: Solid implementation with comprehensive field type support. Minor concerns around complex constraint validation edge cases and code generation modularity. All tasks completed successfully.

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.2-entity-type-definition-editor.yml

---
**Story Points**: 8 (3-4 days)
**Sprint**: Sprint 3
**Priority**: P0 - Must Have
**Dependencies**: Story 3.1 must be completed first